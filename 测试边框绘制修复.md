# 🔧 边框绘制问题修复 - 新方案

## 🐛 问题分析

### 原始问题
- 红色边框只显示在单元格的顶部或底部
- 第一行的顶部边框显示不出来
- 边框不完整，只有部分边框可见

### 可能的原因
1. **绘制顺序问题**：边框被其他元素覆盖
2. **边框宽度问题**：默认边框太细，不够明显
3. **绘制方式问题**：使用 `drawRect` 的 `stroke` 参数可能有问题

## ✅ 新的修复方案

### 1. 创建专门的边框绘制函数
```typescript
const drawCellBorder = (ctx: CanvasRenderingContext2D, cellProps: ICellDrawerProps) => {
  const { x, y, width, height, recordId, fieldId } = cellProps;
  const strokeColor = getCellStroke({ recordId, fieldId });
  
  if (strokeColor && strokeColor !== cellLineColor) {
    ctx.save();
    ctx.strokeStyle = strokeColor;
    ctx.lineWidth = 2; // 增加边框宽度，确保可见
    ctx.beginPath();
    ctx.rect(x, y, width, height);
    ctx.stroke();
    ctx.restore();
  }
};
```

### 2. 分离填充和边框绘制
```typescript
// 先绘制填充
freezeCellPropList.forEach((cellProps) => {
  const { x, y, width, height, fill } = cellProps;
  if (fill) {
    drawRect(ctx, { x, y, width, height, fill });
  }
});

// 绘制其他元素（表头、分组等）
rowHeaderPropList.forEach((rowHeaderProps) => drawRowHeader(ctx, rowHeaderProps));
freezeGroupRowList.forEach((props) => drawGroupRow(ctx, props));

// 最后绘制边框，确保在最上层
freezeCellPropList.forEach((cellProps) => {
  drawCellBorder(ctx, cellProps);
});
```

### 3. 关键改进
- **边框宽度**：从默认的 1px 增加到 2px
- **绘制顺序**：边框在所有其他元素之后绘制
- **独立绘制**：边框绘制与填充绘制分离
- **保存/恢复**：使用 `ctx.save()` 和 `ctx.restore()` 确保不影响其他绘制

## 🧪 测试步骤

### 1. 触发错误状态
```bash
# 方法1：网络断开
1. 开发者工具 → Network → Offline
2. 编辑任意单元格
3. 观察红色边框

# 方法2：服务器错误（已配置20%概率）
1. 编辑单元格
2. 观察是否触发错误
```

### 2. 验证边框完整性
```
✅ 边框宽度应该是 2px（比之前更明显）
✅ 所有单元格的四个边框都应该显示
✅ 边框颜色应该是红色（错误状态）
✅ 边框应该在最上层，不被其他元素覆盖
✅ 第一行数据单元格的边框应该完整显示
```

### 3. 验证不同位置
```
- 第一行数据单元格
- 中间行数据单元格  
- 最后一行数据单元格
- 冻结列和非冻结列
```

## 🎯 预期结果

### 修复前
```
[表头]
[第一行] ← 边框不完整或不可见
[第二行] ← 只有部分边框可见
[第三行] ← 边框被覆盖
```

### 修复后
```
[表头]
[第一行] ← 完整2px红色边框 ✅
[第二行] ← 完整2px红色边框 ✅
[第三行] ← 完整2px红色边框 ✅
```

## 🔍 技术细节

### 绘制顺序优化
```typescript
1. 绘制单元格填充
2. 绘制表头
3. 绘制分组行
4. 绘制边框（最上层）← 关键改进
```

### 边框绘制优化
```typescript
ctx.save();           // 保存当前状态
ctx.strokeStyle = strokeColor;  // 设置边框颜色
ctx.lineWidth = 2;    // 设置边框宽度
ctx.beginPath();      // 开始路径
ctx.rect(x, y, width, height);  // 绘制矩形
ctx.stroke();         // 绘制边框
ctx.restore();        // 恢复状态
```

## 🚀 测试命令

```bash
# 1. 确保开发服务器运行
cd /home/baiyx/teable1020/apps/nestjs-backend
pnpm dev

# 2. 访问应用
# http://localhost:3000

# 3. 测试边框显示
# 编辑单元格触发错误状态，观察边框是否完整显示
```

## 📝 验收标准

- [ ] 边框宽度为 2px，比之前更明显
- [ ] 所有单元格的四个边框都完整显示
- [ ] 边框颜色正确（红色表示错误）
- [ ] 边框在最上层，不被其他元素覆盖
- [ ] 第一行数据单元格的边框完整显示
- [ ] 边框一直保留直到重新编辑
- [ ] 不影响其他UI元素显示
- [ ] 性能无影响

## 🎉 修复完成

通过分离边框绘制和优化绘制顺序，现在红色边框应该能够完整、清晰地显示在所有单元格上！

---

## 📋 展开记录边框显示功能

### 问题描述
单元格的修改显示边框已经正常工作，但展开记录时修改数据还没有边框显示。

### 解决方案

#### 1. 修改 `CellEditorWrap.tsx`
在展开记录的单元格编辑器中添加边框显示功能，参考单元格的实现方式。

```typescript
import { useCellSaveStatus } from '../../hooks/use-cell-save-status';

export const CellEditorWrap = (props: ICellValueEditor) => {
  const { field, wrapClassName, className, cellValue, onChange, readonly, recordId } = props;
  
  // 获取单元格保存状态
  const cellStates = useCellSaveStatus((state) => state.cellStates);
  const cellKey = recordId && field.id ? `${recordId}-${field.id}` : null;
  const saveState = cellKey ? cellStates[cellKey] : null;
  
  // 根据保存状态确定边框颜色
  const getBorderStyle = () => {
    if (!saveState) return {};
    
    const borderColors = {
      saving: 'rgb(96, 165, 250)', // 蓝色
      saved: 'rgb(74, 222, 128)',  // 绿色
      error: 'rgb(248, 113, 113)', // 红色
    };
    
    const borderColor = borderColors[saveState];
    return {
      border: `2px solid ${borderColor}`,
      borderRadius: '4px',
    };
  };
  
  // 为链接字段和普通字段都应用边框
  // ...
}
```

#### 2. 关键改进
- **使用相同的状态管理**：复用 `useCellSaveStatus` hook
- **一致的边框样式**：与单元格边框保持相同的颜色和宽度
- **支持所有字段类型**：包括链接字段和普通字段
- **圆角边框**：添加 4px 圆角，更美观

#### 3. 边框颜色映射
- **蓝色 (saving)**：`rgb(96, 165, 250)` - 数据正在保存
- **绿色 (saved)**：`rgb(74, 222, 128)` - 数据保存成功
- **红色 (error)**：`rgb(248, 113, 113)` - 数据保存失败

### 测试步骤

1. **在表格中触发错误**
   - 开发者工具 → Network → Offline
   - 编辑任意单元格
   - 观察单元格红色边框

2. **打开展开记录**
   - 点击记录展开详情
   - 在展开记录中编辑同一字段
   - 观察是否显示红色边框

3. **验证边框一致性**
   - 表格中的单元格边框：2px 红色
   - 展开记录中的字段边框：2px 红色
   - 边框颜色和宽度应该完全一致

### 预期结果

#### 修复前
```
表格视图：
[单元格1] ← 2px红色边框 ✅
[单元格2] ← 2px红色边框 ✅

展开记录：
[字段1] ← 无边框 ❌
[字段2] ← 无边框 ❌
```

#### 修复后
```
表格视图：
[单元格1] ← 2px红色边框 ✅
[单元格2] ← 2px红色边框 ✅

展开记录：
[字段1] ← 2px红色边框 ✅
[字段2] ← 2px红色边框 ✅
```

### 验收标准

- [x] 修改 `CellEditorWrap.tsx` 添加边框显示
- [ ] 展开记录中的字段显示边框
- [ ] 边框颜色与单元格一致
- [ ] 边框宽度为 2px
- [ ] 支持所有字段类型（文本、数字、链接等）
- [ ] 错误状态边框一直保留直到重新编辑
- [ ] 保存成功时显示绿色边框（500ms后消失）
- [ ] 保存中显示蓝色边框
